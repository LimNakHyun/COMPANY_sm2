<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="sm2">

	<!-- 사업 매출정보 조회 -->
	<select id="selectBoardList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT *
			FROM
				MANAGEMENT
			WHERE
				DELYN = FALSE
			AND
				BUSINESSYEAR = CAST(#{year} AS INTEGER)
			ORDER BY IDX
		]]>
	</select>
	
	<!-- 사업 매출정보 상세보기 조회 -->
	<select id="selectBoardDetail" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT *
			FROM
				MANAGEMENT
			WHERE
				DELYN = FALSE AND
				BUSINESSNAME = #{businessname}
		]]>
	</select>
	
	<!-- 사업 매출정보 등록 -->
	<insert id="insertBoard" parameterType="hashmap">
		<![CDATA[
			INSERT INTO MANAGEMENT
			(
				BUSINESSNAME,
			    CLIENT,
			    STARTTERM,
			    ENDTERM,
			    PLUSTOTALBUSINESSAMOUNT,
			    MINUSTOTALBUSINESSAMOUNT,
			    RATIO,
			    SALESAMOUNT,
			    COLLECTIONCOMPLETEDAMOUNT,
			    TOTALCOLLECTIONREMAININGAMOUNT,
			    CODE,
			    BUSINESSYEAR
			)
			VALUES
			(
				#{businessname},
				#{client},
			    #{startterm},
			    #{endterm},
			    CAST(#{plustotalbusinessamount} AS BIGINT),
			    CAST(#{minustotalbusinessamount} AS BIGINT),
			    CAST(#{ratio} AS DOUBLE PRECISION),
			    CAST(#{salesamount} AS BIGINT),
			    CAST(#{collectioncompletedamount} AS BIGINT),
			    CAST(#{totalcollectionremainingamount} AS BIGINT),
			    #{CODE},
			    CAST(#{year} AS INTEGER)
			)
		]]>
	</insert>
	
	<!-- 사업 월별 수금액 목록 조회 -->
	<select id="selectBoardMonthList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT
				M1.MONTHIDX,
				M1.IDX,
				M1.BUSINESSMONTH,
				M1.COMPLETEYN,
				M1.COLLECTIONCASH,
				M1.MONTHBUSINESSCONDITION,
				M2.TOTALCOLLECTIONREMAININGAMOUNT,
				M2.BUSINESSNAME,
				M2.CLIENT,
				M2.SALESAMOUNT,
				M2.CODE
			FROM
				MONTHMANAGEMENT M1
			LEFT OUTER JOIN
				MANAGEMENT M2
			ON (M1.IDX = M2.IDX)
			WHERE
				M1.DELYN = FALSE
			AND
				BUSINESSMONTH = CAST(#{month} AS INTEGER)
			AND
				BUSINESSYEARMONTH = CAST(#{year} AS INTEGER)
			ORDER BY MONTHIDX
		]]>
	</select>
	
	<select id="pickIdx" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT IDX
			FROM MANAGEMENT
			WHERE BUSINESSNAME = #{businessname}
		]]>
	</select>
	
	<select id="insertBoardMonth" parameterType="hashmap">
		<![CDATA[
			INSERT INTO MONTHMANAGEMENT
			(
				IDX,
			    BUSINESSMONTH,
			    COLLECTIONCASH,
			    BUSINESSYEARMONTH
			)
			VALUES
			(
				#{idx},
				CAST(#{month} AS INTEGER),
			    CAST(#{salesamount} AS INTEGER),
			    CAST(#{year} AS INTEGER)
			)
		]]>
	</select>
	
	<select id="collectionInformation" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT COLLECTIONCOMPLETEDAMOUNT, TOTALCOLLECTIONREMAININGAMOUNT
			FROM MANAGEMENT
			WHERE IDX = CAST(#{idx} AS INTEGER)
		]]>
	</select>
	
	<update id="updateBoardMonth" parameterType="hashmap">
		<![CDATA[
			UPDATE MANAGEMENT
			SET
			COLLECTIONCOMPLETEDAMOUNT = #{collectioncompletedamount},
			TOTALCOLLECTIONREMAININGAMOUNT = #{totalcollectionremainingamount},
			BUSINESSCONDITION = #{businesscondition}
			WHERE IDX = CAST(#{idx} AS INTEGER)
		]]>
	</update>
	
	<update id="updateBoardMonthCondition" parameterType="hashmap">
		<![CDATA[
			UPDATE MONTHMANAGEMENT
			SET
			MONTHBUSINESSCONDITION = #{monthbusinesscondition}
			WHERE MONTHIDX = CAST(#{monthidx} AS INTEGER)
		]]>
	</update>
	
	<select id="selectBoardAmount" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT
				COALESCE(SUM(PLUSTOTALBUSINESSAMOUNT), 0) AS PLUSTOTALBUSINESSAMOUNTSUM,
				COALESCE(SUM(MINUSTOTALBUSINESSAMOUNT), 0) AS MINUSTOTALBUSINESSAMOUNTSUM,
				COALESCE(SUM(SALESAMOUNT), 0) AS SALESAMOUNTSUM,
				COALESCE(SUM(COLLECTIONCOMPLETEDAMOUNT), 0) AS COLLECTIONCOMPLETEDAMOUNTSUM,
				COALESCE(SUM(TOTALCOLLECTIONREMAININGAMOUNT), 0) AS TOTALCOLLECTIONREMAININGAMOUNTSUM
			FROM MANAGEMENT
			WHERE 
				DELYN = FALSE
			AND BUSINESSYEAR = CAST(#{year} AS INTEGER)
		]]>
	</select>
	
	<select id="selectBoardMonthAmount" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT
				COALESCE(SUM(COLLECTIONCASH), 0) AS COLLECTIONCASHSUM
			FROM MONTHMANAGEMENT
			WHERE
				BUSINESSYEARMONTH = CAST(#{year} AS INTEGER)
			AND
				BUSINESSMONTH = CAST(#{month} AS INTEGER)
			AND
				MONTHBUSINESSCONDITION = TRUE
		]]>
	</select>

</mapper>