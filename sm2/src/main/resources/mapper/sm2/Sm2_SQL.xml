<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="sm2">

	<!-- 사업 매출정보 조회 -->
	<select id="selectBoardList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT *
			FROM
				SM.MANAGEMENT
			WHERE
				DELYN = FALSE
			AND
				BUSINESSYEAR = CAST(#{year} AS INTEGER)
			ORDER BY IDX
		]]>
	</select>
	
	<!-- 사업 매출정보 상세보기 조회 -->
	<select id="selectBoardDetail" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT *
			FROM
				SM.MANAGEMENT
			WHERE
				DELYN = FALSE AND
				BUSINESSNAME = #{businessname}
			AND
				BUSINESSYEAR = CAST(#{year} AS INTEGER)
		]]>
	</select>
	
	<!-- 사업 매출정보 등록 -->
	<insert id="insertBoard" parameterType="hashmap">
		<![CDATA[
			INSERT INTO SM.MANAGEMENT
			(
				BUSINESSNAME,
			    CLIENT,
			    STARTTERM,
			    ENDTERM,
			    PLUSTOTALBUSINESSAMOUNT,
			    MINUSTOTALBUSINESSAMOUNT,
			    RATIO,
			    SALESAMOUNT,
			    COLLECTIONCOMPLETEDAMOUNT,
			    TOTALCOLLECTIONREMAININGAMOUNT,
			    CODE,
			    BUSINESSYEAR
			)
			VALUES
			(
				#{businessname},
				#{client},
			    #{startterm},
			    #{endterm},
			    CAST(#{plustotalbusinessamount} AS BIGINT),
			    CAST(#{minustotalbusinessamount} AS BIGINT),
			    CAST(#{ratio} AS DOUBLE PRECISION),
			    CAST(#{salesamount} AS BIGINT),
			    CAST(#{collectioncompletedamount} AS BIGINT),
			    CAST(#{totalcollectionremainingamount} AS BIGINT),
			    #{CODE},
			    CAST(#{year} AS INTEGER)
			)
		]]>
	</insert>
	
	<!-- <update id="deleteBoard" parameterType="hashmap">
		<![CDATA[
			
		]]>
	</update>
	
	<update id="deleteRelatedMonthBoard" parameterType="hashmap">
		<![CDATA[
			
		]]>
	</update> -->
	
	<!-- 사업 월별 수금액 목록 조회 -->
	<select id="selectBoardMonthList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT
				M1.MONTHIDX,
				M1.IDX,
				M1.BUSINESSMONTH,
				M1.COMPLETEYN,
				M1.COLLECTIONCASH,
				M1.MONTHBUSINESSCONDITION,
				M2.TOTALCOLLECTIONREMAININGAMOUNT,
				M2.BUSINESSNAME,
				M2.CLIENT,
				M2.SALESAMOUNT,
				M2.CODE
			FROM
				SM.MONTHMANAGEMENT M1
			LEFT OUTER JOIN
				SM.MANAGEMENT M2
			ON (M1.IDX = M2.IDX)
			WHERE
				M1.DELYN = FALSE
			AND
				BUSINESSMONTH = CAST(#{month} AS INTEGER)
			AND
				BUSINESSYEARMONTH = CAST(#{year} AS INTEGER)
			ORDER BY MONTHIDX
		]]>
	</select>
	
	<!-- 해당하는 사업명 인덱스 조회 -->
	<select id="pickIdx" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT IDX
			FROM SM.MANAGEMENT
			WHERE
				BUSINESSNAME = #{businessname}
			AND
				DELYN = FALSE
			AND
				BUSINESSYEAR = CAST(#{year} AS INTEGER)
		]]>
	</select>
	
	<!-- 월별 사업 매출정보 등록 -->
	<select id="insertBoardMonth" parameterType="hashmap">
		<![CDATA[
			INSERT INTO SM.MONTHMANAGEMENT
			(
				IDX,
			    BUSINESSMONTH,
			    COLLECTIONCASH,
			    BUSINESSYEARMONTH
			)
			VALUES
			(
				#{idx},
				CAST(#{month} AS INTEGER),
			    CAST(#{salesamount} AS INTEGER),
			    CAST(#{year} AS INTEGER)
			)
		]]>
	</select>
	
	<!-- 사업수금액 정보 조회 -->
	<select id="collectionInformation" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT
				COLLECTIONCOMPLETEDAMOUNT,
				TOTALCOLLECTIONREMAININGAMOUNT
			FROM
				SM.MANAGEMENT
			WHERE
				IDX = CAST(#{idx} AS INTEGER)
			AND
				DELYN = FALSE
		]]>
	</select>
	
	<!-- 사업수금액 정산 -->
	<update id="updateBoardMonth" parameterType="hashmap">
		<![CDATA[
			UPDATE
				SM.MANAGEMENT
			SET
				COLLECTIONCOMPLETEDAMOUNT = #{collectioncompletedamount},
				TOTALCOLLECTIONREMAININGAMOUNT = #{totalcollectionremainingamount},
				BUSINESSCONDITION = #{businesscondition}
			WHERE
				IDX = CAST(#{idx} AS INTEGER)
			AND
				DELYN = FALSE
		]]>
	</update>
	
	<!-- 사업수금액 완료 상태 변경 -->
	<update id="updateBoardMonthCondition" parameterType="hashmap">
		<![CDATA[
			UPDATE
				SM.MONTHMANAGEMENT
			SET
				MONTHBUSINESSCONDITION = #{monthbusinesscondition}
			WHERE
				MONTHIDX = CAST(#{monthidx} AS INTEGER)
			AND
				DELYN = FALSE
		]]>
	</update>
	
	<!-- 사업금액 전체 합계 조회 -->
	<select id="selectBoardAmount" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT
				COALESCE(SUM(PLUSTOTALBUSINESSAMOUNT), 0) AS PLUSTOTALBUSINESSAMOUNTSUM,
				COALESCE(SUM(MINUSTOTALBUSINESSAMOUNT), 0) AS MINUSTOTALBUSINESSAMOUNTSUM,
				COALESCE(SUM(SALESAMOUNT), 0) AS SALESAMOUNTSUM,
				COALESCE(SUM(COLLECTIONCOMPLETEDAMOUNT), 0) AS COLLECTIONCOMPLETEDAMOUNTSUM,
				COALESCE(SUM(TOTALCOLLECTIONREMAININGAMOUNT), 0) AS TOTALCOLLECTIONREMAININGAMOUNTSUM
			FROM
				SM.MANAGEMENT
			WHERE 
				DELYN = FALSE
			AND
				BUSINESSYEAR = CAST(#{year} AS INTEGER)
		]]>
	</select>
	
	<!-- 월별 사업금액 합계 조회 -->
	<select id="selectBoardMonthAmount" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT
				COALESCE(SUM(COLLECTIONCASH), 0) AS COLLECTIONCASHSUM
			FROM
				SM.MONTHMANAGEMENT
			WHERE
				BUSINESSYEARMONTH = CAST(#{year} AS INTEGER)
			AND
				BUSINESSMONTH = CAST(#{month} AS INTEGER)
			AND
				MONTHBUSINESSCONDITION = TRUE
			AND
				DELYN = FALSE
		]]>
	</select>
	
	<!-- 사업 월별 수금액 정보 상세보기 조회 -->
	<select id="selectBoardMonthDetail" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT
				M1.MONTHIDX,
				M1.IDX,
				M1.BUSINESSMONTH,
				M1.DELYN AS MONTHDELYN,
				M1.DELDATE AS MONTHDELDATE,
				M1.COMPLETEYN,
				M1.COLLECTIONCASH,
				M1.MONTHBUSINESSCONDITION,
				M1.BUSINESSYEARMONTH,
				M2.BUSINESSNAME,
				M2.CLIENT,
				M2.STARTTERM,
				M2.ENDTERM,
				M2.PLUSTOTALBUSINESSAMOUNT,
				M2.MINUSTOTALBUSINESSAMOUNT,
				M2.RATIO,
				M2.SALESAMOUNT,
				M2.COLLECTIONCOMPLETEDAMOUNT,
				M2.TOTALCOLLECTIONREMAININGAMOUNT,
				M2.DELYN,
				M2.DELDATE,
				M2.BUSINESSCONDITION,
				M2.CODE,
				M2.TABLEDELYN,
				M2.TABLEDELDATE,
				M2.BUSINESSYEAR
			FROM
				SM.MONTHMANAGEMENT M1
			LEFT OUTER JOIN
				SM.MANAGEMENT M2
			ON (M1.IDX = M2.IDX)
			WHERE
				M1.DELYN = FALSE
			AND
				MONTHIDX = CAST(#{monthidx} AS INTEGER)
		]]>
	</select>
	
	<!-- 사업 월별 수금액 정보 삭제 -->
	<update id="deleteMonthBoard" parameterType="hashmap">
		<![CDATA[
			UPDATE
				SM.MONTHMANAGEMENT
			SET
				DELYN = TRUE
			WHERE
				MONTHIDX = CAST(#{monthidx} AS INTEGER)
		]]>
	</update>
	
	<!-- 사업 월별 수금완료 여부 조회 -->
	<select id="pickMonthBusinessCondition" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT 
				MONTHBUSINESSCONDITION
			FROM
				SM.MONTHMANAGEMENT
			WHERE
				MONTHIDX = CAST(#{monthidx} AS INTEGER)
			AND
				DELYN = FALSE
		]]>
	</select>
	
	<!-- 사업 수금완료 여부 조회 -->
	<select id="pickBusinessCondition" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT 
				BUSINESSCONDITION
			FROM
				SM.MANAGEMENT
			WHERE
				IDX = CAST(#{idx} AS INTEGER)
			AND
				DELYN = FALSE
		]]>
	</select>
	
	<!-- 사업 수금악 상태 변경 -->
	<update id="updateBoardBusinessCondition" parameterType="hashmap">
		<![CDATA[
			UPDATE
				SM.MANAGEMENT
			SET
				BUSINESSCONDITION = FALSE
			WHERE
				IDX = CAST(#{idx} AS INTEGER)
			AND
				DELYN = FALSE
		]]>
	</update>

</mapper>